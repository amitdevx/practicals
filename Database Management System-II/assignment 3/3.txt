Assignment 3: Cursors
PL/SQL Cursors provide a way to select multiple rows of data from the database and then to process
each row individually. Using a cursor, we can traverse up and down a result set and retrieve only those
rows which are explicitly requested. Cursors basically help an application to efficiently use a static
result set.
Declaring Cursor Variables
All access to cursors in PL/pgSQL goes through cursor variables, which are always of the special data
type refcursor. We can declare a cursor variable either as a bound cursor variable or an unbound cursor
variable.
a. To create an unbound cursor variable, just declare it as a variable of type refcursor.
b. To create a bound cursor variable, use the following cursor declaration.
syntax
name CURSOR [ ( arguments ) ] FOR query;
where arguments, if specified, is a comma-separated list of pairs ‘name datatype’ that define names to
be replaced by parameter values in the given query. The actual values to substitute for these names will
be specified later, when the cursor is opened (parameterized cursors).
Opening Cursors
Before a cursor can be used to retrieve rows, it must be opened. PL/pgSQL has three forms of the
OPEN statement, two of which use unbound cursor variables while the third uses a bound cursor
variable.
Syntax for OPEN FOR query
OPEN unbound_cursorvar FOR query;
Syntax for OPEN FOR EXECUTE
OPEN unbound_cursorvar FOR EXECUTE query_string USING expression [, ... ] ];
Syntax for Opening a Bound Cursor
OPEN bound_cursorvar [ ( argument_values ) ];
Using Cursors
Once a cursor has been opened, it can be manipulated with the statements describedbelow.
FETCH
Syntax :
FETCH [ direction { FROM | IN } ] cursor INTO target;
The direction clause can be any of the following variants :
NEXT, PRIOR, FIRST, LAST, ABSOLUTE count, RELATIVE count, FORWARD,
orBACKWARD. Default is NEXT.
MOVE : MOVE repositions a cursor without retrieving any data.
Syntax :
MOVE [ direction { FROM | IN } ] cursor;
The
direction clause can be any of the variants NEXT, PRIOR, FIRST, LAST,
37ABSOLUTEcount, RELATIVE count, ALL, FORWARD [ count | ALL ], or BACKWARD [
count | ALL ].
CLOSE : CLOSE closes the portal underlying an open cursor. This can be used to releaseresources
earlier than end of transaction, or to free up the cursor variable to be openedagain.
Syntax :
CLOSE cursor;
Example 1:
Consider a relation, Employee (eno, ename, deptno,salary). We write a function, to Definea cursor to
print the details of the employee along with commission earned for eachemployee. Commission is 20%
of salary for employees of dept no = 5; its 50% of salary foremployees of dept no = 8; its 30% of salary
for employees of dept no = 10.
Create function cursor_demo( ) returns integer as ‘
Declare
Emp–rec Employee%rowtype
C–emp cursor for Select * from employee; Comm
Number (6,2);
Begin
Loop
Fetch C–emp into emp–rec; If emp–rec.deptno
= 5 then
Comm:= emp–rec.salary * 0.2; Else if emp–rec.deptno = 8
then
Comm := emp–rec.salary * 0.5; Else If emp–rec.deptno = 10
then
Comm := emp–rec.salary * 0.3;
End if; End if; Endif;
Raise notice ‘’emp–rec.ename||emp–rec.deptno||emp–rec.salary||comm. ‘’; Exit when
not found;
End loop;
Close C–emp;
End; ‘ language ‘plpgsql’;
Example 2:
Consider the following relations, Dept(dno, dname) Employee(eno, dno, ename, salary) and the
relation between Dept and Employee is one to many(1:M). Now we write a PL/pgSQL function to print
the list of employees, department wise. Here we use 2 cursors, the 1st Cursor retrieves the department
Information for each department and the 2nd cursor, to which dept number is sent as a parameter
retrieves the employees for that department.
Create function parameterizedcursor_demo( ) returns integer as ‘
Declare
Begin
38d–Info cursor for Select * from dept;
E–Info cursor (dnumdept.dno%type) for Select * From
Emplyee Where dno = dnum; X number := 0;
For drecIn d–Info Loop
Raise notice ‘’ drec.dno || drec.dname’’; For erecIn E–Info
(drec.dno)
Loop
Raise notice ‘’erec.eno || erec.ename || erec.salary’’; X := X + 1;
End loop;
Raise notice “Total employees for:||drec.dname||‘is %’|| X’’; End loop;
Return (X);
End; ‘ language ‘plpgsql’;
NOTE: Solve any three sets from the Following:
SET A
Bus – Route Database
Consider the following database
Bus (bus_no int, capacity int , depot_name varchar(20))
Route (route_no int, source varchar(20), destination varchar(20), No_of_stations int) Bus
and Route are related with many to many relationship.
Create the above database in PostGreSQL and insert sufficient records.
a. Write a stored function using cursor, which will give details of all routes on which bus no
108 is running.
b. Write a stored function using cursor, which will give details of all buses on route from
“Station” to “Airport”.
SET B
Student –Teacher database
Consider the following database
Teacher( t_no int, t_name varchar(20), age int, yr_experience int)
Subject (s_no int, s_namevarchar(15))
Teacher and Subject are related with many to many relationship
Create the above database in PostGreSQL and insert sufficient records.
a. Write a stored function using cursor which will accept the subject name and print the
names of all teachers teaching that subject.
b. Write a cursor to accept the subject's name from the user as an input and display names
of all teachers teaching that student.
39SET C
Person - Area Database
Person (pno int, name varchar (20), birthdate date, income money) Area
(aid int, aname varchar (20), area_type varchar (5) )
The person and area related to many to one relationship. The attribute ‘area_type’ can have values
either ‘urban’ or ‘rural’.
Create the above database in PostGreSQL and insert sufficient records.
a. Write a cursor to accept a month as an input parameter from the user and display the
names of persons whose birthday falls in that particular month.
b. Write a cursor to display the names of persons living in urban area.
c. Write a cursor to print names of all persons having income between50,000 and 1,00,000.
SET D
Student – Competition Database
Consider the following entities and their relationship.
Student (s_reg_no int, s_name varchar(20), s_class varchar(20))
Competition (comp_no int, comp_name varchar(20), comp_type varchar(20))
Relationship between Student and Competition is many-to-many with descriptive attribute rank and
year.
a) Write a cursor which will display year wise details of competitions held. (Use
parameterized cursor)
b) Write a cursor which will display student wise total count of competition participated.
SET E
Car – Driver Database
Consider the following database:
Car (c_no int, owner varchar(20), model varchar(10), color varchar(10)
Driver (driver_no int, driver_namevarchar(20), license_no int, d_age int, salary float) Car
and Driver are related with many to many relationship
Create the above database in PostGreSQL and insert sufficient records.
a. Write a stored function with cursor which accepts the color and prints the names of all
owners who own a car of that color.
b. Write a cursor which accepts the driver name and prints the details of all cars that
this driver has driven, if the driver name is invalid, print an appropriate message.
